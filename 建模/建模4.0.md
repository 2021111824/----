# 面向公平性的云边微服务系统部署方法

###  建模

#### 1 场景描述

在**实时视频流**等服务中，用户分布广泛，既有**城市中心用户**，也有**偏远地区用户**，他们通过各种终端设备接入系统。为了提升服务质量，本研究采用**云-边协同计算架构**，即在多个地理位置部署**边缘服务器**，同时依托**云服务器**提供计算支持。

然而，在这一架构下，如何确保**不同用户在资源受限的环境下获得公平的服务体验**是核心挑战。公平性问题主要体现在以下两个方面：

* **同优先级用户间的公平性**

  * 由于地理位置不同，用户的**网络条件差异较大**，靠近边缘服务器的用户具有较低的传输延迟，而远离服务器的用户可能面临较长的传输延迟，导致**同一优先级的用户体验不均衡**。

  * 目标：**同一优先级用户的响应时间应尽量相近**，避免因地理因素导致不公平的服务体验。

* **跨优先级用户的公平性**

  * 在实际应用中，用户可分为**不同优先级**（如普通用户、VIP用户等）。其中**高优先级用户**通常是付费用户，他们期望获得更快的响应时间和更稳定的服务体验。

  * 但在**边缘服务器资源有限**环境下，系统无法为所有用户都提供最优的服务质量，因此需要**优先保障高优先级用户的服务质量**。具体来说，**高优先级用户**应当获得**更短的平均响应时间**，以确保他们的服务体验相较低优先级用户**始终保持优势**。

  * 目标：在**资源受限**的情况下，确保高优先级用户的平均响应时间优于低优先级用户，即**优先满足高优先级用户的服务需求**。

    

**目标**

本研究旨在设计一种**面向公平性的云-边微服务部署优化策略**，以提高云-边协同计算的公平性和资源利用效率。在**资源受限环境**下，实现以下优化目标：

1. **同一优先级用户的公平性**：确保**相同优先级的用户**在不同地理位置和网络条件下，获得尽可能均衡的服务响应时间，避免因网络环境差异导致体验不均衡。

2. **跨优先级用户的服务保障**：在资源受限情况下，优先保障高优先级用户的服务质量，使其平均响应时间始终优于低优先级用户，确保资源分配符合优先级策略。

3. **微服务的动态部署与资源优化**：根据不同服务器的计算能力、网络延迟、带宽等因素，合理部署微服务实例，最大化资源利用率，并降低计算和通信成本。

   

#### 2 定义变量

a.  **用户集 $U$**：  
    $U = \{u_1, u_2, \cdots, u_n\}$，表示所有用户，每个用户可以用一个多维变量来表示
$$
u_i = < loc_i, Q_i, W_i, D_i>
$$

* $loc_i = (x_i, y_i)$ 表示用户所处的**地理位置**；
* $Q_i = \{1, 2, \cdots\}$ 是系统根据用户的**重要程度**（如普通用户、付费用户等）来为用户赋予的变量，代表用户的优先级。$Q_i$ 值越大，代表用户的重要程度越高。
* $W_i$ 为用户权重，由系统依据 $Q_i$ 来分配，并且通常与 $Q_i$ 成正比关系，即用户优先级越高，权重越大。$W_i$ 在模型中有两个关键作用：
  * 其一，影响服务器对用户的资源分配过程，权重高的用户（即高优先级用户）会被服务器优先分配到更丰富资源；
  * 其二，在计算公平性指标时，$W_i$ 会确保高优先级用户在公平性计算中占据更大的比重，以此来体现对重要用户的侧重考量。
* $D_i$ 表示用户 $u_i$ 发往服务器（云或边缘）的数据量（比特），该值取决于用户实际的计算需求。



b.  **服务集 $S$**：  
    $S = \{s_1, s_2, \cdots, s_m\}$，表示所有可可供用户连接的边缘和云服务器的集合，$S = S_{edge} \cup S_{cloud}$。

* **边缘服务器**可以描述为：
  $$
  s_{j}^{edge} = <loc_j, R_j^{server}, P_j, b_j, delay_j, c_{fixed_j}^e>
  $$

  * $loc_j = (x_j, y_j)$ 表示服务器所处的**地理位置**；
  * $R_j^{server} = <r_j^{cpu\_total}, r_j^{mem\_total}, \cdots >$ 表示边缘服务器各种资源；
  * $P_j$ 代表边缘服务器的总计算能力；
  * $c_{fixed_j}^e$ 为租赁边缘服务器的固定费用；
  * $b_j$ 代表服务器的全部可用带宽；
  * $delay_j$ 代表用户与服务器之间的延迟。
  
* **云服务器**可以描述为：
  $$
  s_{j}^{cloud} = <loc_j, R_j^{server}, P_j, b_j, delay_j, p_{net}^c>
  $$
  

  * $loc_j, R_j^{server}, P_j, b_j, delay_j$与边缘服务器中定义相同；
  
  * $p_{net}^c$ 为云服务器单位流量（bit）成本。
  
    

c. **连接变量 $x_{ij}$**：  
    用二进制变量 $x_{ij}$ 表示用户 $u_i$ 是否连接到边缘或云服务器 $s_j$ 。
$$
x_{ij} = 
\begin{cases} 
  1 & 用户 u_i 连接到服务器 s_j \\
  0 & 用户 u_i 没有连接到服务器 s_j
\end{cases}
$$
  * 在本实验场景中，所有用户均请求相同的服务实例，这些服务实例部署在服务器上。每个服务器具有部署一个或多个此类服务实例的能力；若某个服务器未连接任何用户，那么该服务器也可以选择不部署服务实例。



d.  **计算资源分配 $R_{i}^{user}$**  
用 $R_{i}^{user}$ 表示用户 $u_i$连接到服务器 $s_j$时，服务器需要分配的资源来处理请求。
$$
R_{i}^{user} = f(D_i) \cdot W_i
$$

* 服务器根据**用户请求的数据量** $D_i$ 以及**用户的权重** $W_i$ 给用户进行资源分配。通过 $W_i$ 进行加权，使得高优先级用户能获取更多资源，体现了模型对不同优先级用户资源分配的差异化处理。



e. 处理能力 分配$P_{ij}$

用户 $u_i$ 连接到服务器 $s_j$ 时，服务器分配给用户的**资源量**决定了服务器对该用户请求的**处理能力**：
$$
P_{ij}^x = (\frac{R_i}{\sum_{u_k \in U}{R_k}}) \cdot P_j^x , x_{kj} = 1
$$

  * **$P_{ij}^x$**：表示服务器 $s_j$ 分配给**用户** $u_i$ 的**计算能力**，其中 $x$ 可以是 `e` 或 `c`，分别代表边缘服务器和云服务器。

  * **$P_j^x$**：表示服务器 $s_j$ 的**总处理能力**，对于边缘服务器是 $P_j^e$，对于云服务器是 $P_j^c$。（通常情况下云服务器资源较丰富，即 $P_j^e < P_j^c$）

  * **$\frac{R_i}{\sum_{u_k \in U}{R_k}}$**：表示用户 $u_i$ 在服务器 $s_j$ 上所**分配的资源量** $R_i$ 与该服务器上**所有用户** $u_k$ 分配的**资源总和**的比例。

  * 通过比例分配，每个用户获得的**计算能力**是与其**分配的资源量**成**正比**的。



f.   **响应时间 $t_{ij}$**：  
   用 $t_{ij}$ 表示用户 $u_i$ 连接到服务器 $s_j$ 的响应时间，由发送延迟 $t_{send_{ij}}$、传播延迟 $t_{delay_{ij}}$ 和处理延迟 $t_{proc_{ij}}$ 三部分组成。
$$
t_{ij} = t_{send_{ij}}+t_{delay_{ij}}+t_{proc_{ij}}
$$

- **发送延迟 $t_{send_{ij}} = \frac {D_i}{b_{ij}}$**，为用户请求的数据量与用户服务器之间的带宽比；
- **传播延迟** $t_{trans_{ij}}^{e} = \frac {d_{ij}}{v}$，即前面服务器定义中的用户与服务器之间的延迟；

* **处理延迟** $t_{proc_{ij}} = \frac{D_{i}}{P_{ij}}$。为用户请求数据量与服务器分配给用户的处理能力之比。  
  
   

g. **加权响应时间 $t_{ij}^{weight}$**  ：为用户的响应时间与用户权重的乘积
$$
t_{ij}^{weight} = t_{ij} \cdot W_i
$$

h.   **部署实例成本 $c_j$**：  
  用 $c_j$ 表示在服务器 $s_j$ 部署服务的成本，由于云节点和边缘节点的差异性，二者的部署成本也有所不同。

  * **边缘节点部署成本** $c_j^e$ ：
    $$
    c_{j}^e = c_{fixed_j}^e + c_{usage_j}^e
    $$

    * **固定成本** $c_{fixed_j}^e$ ：用于租赁边缘服务器（每个边缘节点的固定租赁费用）；
    * **资源使用成本** $c_{usage_j}^e$ ：是边缘节点在实际运行中产生的资源消耗成本，如 $CPU$、内存和带宽消耗，按资源占用进行计算：

    $$
    c_{usage_j}^e = \sum_{i = 1}^{n} x_{ij} \ \cdot (R_{i}^{user} \ \cdot p_{R}^{e} )
    $$
    其中，$p_{R}^{e}$ 为边缘服务器的资源的单价；$x_{ij}$ 表示用户 $u_i$是否连接到服务器 $s_j$。




* **云节点部署成本** $c_j^c$ （云节点通常基于资源使用量付费，可以根据资源消耗量和处理请求数量来计算成本）：
  $$
  c_{j}^c = c_{usage_j}^c + c_{net_j}^c
  $$

  * **云资源使用成本** $c_{usage_j}^c$ ：按需计算，包括 $CPU$、内存和带宽使用量。
$$
c_{usage_j}^c = \sum_{i = 1}^{n} x_{ij} \ \cdot (R_{i}^{user} \ \cdot p_{R}^{c})
$$
其中，$p_{R}^{c}$ 为云服务器的资源的单价；$x_{ij}$ 表示用户 $u_i$是否连接到服务器 $s_j$。

  * **网络流量成本** $c_{net_j}^c$ ：用户从不同区域访问云，产生的额外网络传输费用，根据流量数据量计算。
$$
c_{net_j}^c = \sum_{i = 1}^{n} x_{ij} \ \cdot D_i \ \cdot p_{net}^{c}
$$

  &nbsp;&nbsp;&nbsp;&nbsp;
  	其中，$p_{net}^{c}$ 为云平台的流量单价，$D_i$ 为用户 $u_i$ 的数据请求的大小。

* **综合部署成本**  
  总部署成本可表示为所有边缘和云节点成本的总和：
  $$
  C_{total} = \sum_{s_j  \in S_{edge}} c_{j}^e   + \sum_{s_j \in S_{cloud}} c_{j}^c  
  $$

### 2.2.2 目标函数（优化公平性）

* **公平性目标函数**：用 $f$ 表示， 即
  $$
  f = max (F_{Jain})
  $$
  其中：
  * $F_{Jain}$ 是Jain公平性指数，定义为：
  $$
  F_{\text{Jain}} = \frac{\left( \sum_{i=1}^{n} t_{ij}^{weight} \right)^2}{n \cdot \sum_{i=1}^{n} \left(t_{ij}^{weight}\right)^2}
  $$
    $t_{ij}^{weight} = t_{ij}  \cdot  W_i$ 是 加权响应时间，$n$ 是用户总数。

* **公式解释**：    
  
  * **分子**：代表了所有用户加权响应时间总和的平方。其反映了**加权时间的集中程度**，假设每个用户的**加权响应时间较为相近**，**总和会较大**，平方后得到的值也会较大，这种情况通常代表系统中各**用户之间的响应时间差异较小**。
  * **分母**：是所有用户加权响应时间的平方和。平方后的响应时间的和反映了系统中所有用户响应时间的散布程度。如果所有用户的**响应时间相差较大**，那么这个**和将会较大**，意味着**公平性较差**。
  
* **作用分析**：
    * **优化公平性**：通过最大化 $F_{Jain}$ ，就是在最小化所有用户的额响应时间差异。当 $F_{Jain}$ 趋近于1时，表示所有用户的响应时间几乎完全相同，系统达到了公平性；而当 $F_{Jain}$ 趋近于0时，说明响应时间差异非常大，系统非常不公平。
    * **公平性评估**：目标函数是最大化 $F_{Jain}$ ,即提高公平性。
    * **不同优先级用户的公平性保证**：引入**加权响应时间**后，系统能够根据**用户优先级调节不同用户之间的响应时间差异**，实现对不同优先级用户的“公平性优化”。也就是说，它能保证不同优先级用户的响应时间是公平的。
* **加权作用**：      
  * **影响分子的集中性**：如果高权重用户的响应时间 $t_{ij}$ 更短，则这些用户的加权响应时间 $t_{ij}^{\text{weight}}$ 会更接近低权重用户的加权响应时间，使得总和变得更加集中（差异减小）。
  * **影响分母的分散性**：如果高权重用户的响应时间更短，分母中的高权重用户的平方项对分母的贡献会减少，从而整体分母也会变小。

### 2.2.3 约束条件
#### 约束1：不同优先级用户的平均响应时间约束
为每个优先级类别的用户设定一个不同的最大允许的平均响应时:  

$$
\frac{1}{|U_{Q_i}|} \sum_{u_j \in U_{Q_i}} \sum_{s_k \in S} x_{jk} \cdot t_{jk} \leq T_{Q_i}^{max}, \quad \forall Q_i
$$
$T_{Q_i}^{max}$ 是优先级类别 $Q_i$ 的最大响应时间上限。这个约束确保每个优先级类别的用户响应时间不会超过设定的上限。

#### 约束2：部署成本
* 用 $C_{edge}$ 表示边缘节点的总预算，用 $C_{cloud}$ 表示云端的总预算。两者的总和不得超过服务提供商的整体预算 $C_{max}$ 。


$$
  C_{edge}  + C_{cloud}  =  \sum_{s_j \in S_{edge}} c_j^e + \sum_{s_j \in S_{cloud}} c_j^c \leq C_{max}
$$

  其中，$S_{edge}$ 为所有边缘节点集合，$S_{cloud}$ 为云端节点集合，$c_j$ 表示在节点 $s_j$ 上部署的成本。

#### 约束3：边缘节点计算资源限制
* 每个边缘节点 $s_j$ 的资源消耗不超过其最大可用资源。
  $$
  \sum_{i=1}^{n} x_{ij} ⋅ R_{i}^{user} \leq R_j^{server} , \forall s_j \in S
  $$


​	即，服务器分配给连接到它的所有资源之和不超过服务器的总资源。

#### 约束4：用户与服务器的连接

* 每个用户 $u_i$ 必须连接到唯一一个服务器：
  $$
  \sum_{j=1}^{m} x_{ij} = 1, \forall u_i \in U
  $$



