# 面向公平性的云边微服务系统部署方法

### A. 系统建模

本文研究**云-边协同环境**下的**公平性优化微服务部署问题**。系统由一组**边缘服务器**（记作 $S_{edge}$）和**云服务器**（记作 $S_{cloud}$）组成，用户请求的服务将在这些服务器上处理。边缘服务器由系统完全控制，而云服务器按**按需计费**模式提供服务资源。



#### **定义 1（用户）**

设 $U$ 为用户集合，每个用户 $u_i \in U$ 具有以下属性：
$$
u_i = \langle  L_i, W_i, Q_i \rangle
$$
其中：

* **$L_i$**：用户的**优先级**（取值为 $1,2,3, \cdots$），数值越大表示用户的重要程度越高
* **$W_i$**：用户的**权重**，与 $L_i$ 成正比
* **$Q_i = <D_i^{in}, D_i^{out}, p_i>$**：表示用户的请求集合。
  * $D_i^{in}$ 为该请求的**输入**数据量大小；
  * $D_i^{out}$ 为该请求的**输出**数据量大小；
  * $p_i$ 为处理该请求需要的**计算单位数**。

用户请求的服务需要被分配到某台**边缘服务器**或**云服务器**进行处理。



#### 定义2（服务器）

##### **a. 边缘服务器**

每个**边缘服务器** $s_j^{edge} \in S_{edge}$ 具有以下属性：
$$
s_{j}^{edge} = < R_j^{server}, c_{fixed_j}^e>
$$
其中：

* $R_j^{server} = <r_j^{CPU}, r_j^{RAM}, \cdots >$ ：表示边缘服务器 $s_j$ 提供的可用计算资源（包括$CPU 、RAM$ 等）；
* $c_{fixed_j}^e$ ：表示租赁服务器 $s_j$ 的固定成本。

系统中**用户终端**与**边缘服务器**之间的**网络带宽**和**通信延迟**分别表示为：
$$
B^e = \{ b_{i,j}^e | \forall u_i \in U, \forall s_j \in S_{edge}  \}
$$

$$
D^e = \{ t_{d_{i,j}}^e | \forall u_i \in U, \forall s_j \in S_{edge}  \}
$$

##### b. 云服务器

**云服务器** $S_{cloud}$ 资源丰富，在云服务器上处理**每个单位计算需求**的价格为 $p_{net}$。

系统中**用户终端**与**云服务器**之间的**网络带宽**和**通信延迟**分别表示为：
$$
B^c = \{ b_{i}^c | \forall u_i \in U  \}
$$

$$
D^c = \{ t_{d_{i}}^e | \forall u_i \in U \}
$$

由于云服务器距离用户较远，其通信延迟一般大于边缘服务器，即 $t_{i}^c > t_{i,j}^e$。



#### 定义3（微服务）

设 $m$ 为系统提供的微服务（在本研究的场景中，系统只提供一种微服务），
$$
m = \langle P^m, r^m \rangle
$$
其中：

* **$P^m$**：表示 $m$ 的**计算能力**，即**每个服务实例**单位时间可处理的计算单位数。
* **$r^m$**：表示运行 $m$ 的服务实例所需的**计算资源**（如 CPU、RAM等）。



**微服务部署方案** **Y** 描述了**微服务实例在服务器上的部署状态**：
$$
Y = \{ y_{j} | s_j \in S_{edge}, y_j \in \mathbb{N} \}
$$
其中，$y_{j}$ 表示在边缘服务器 $s_j$ 上运行的**服务实例数量**。在微服务架构中，通过在多个节点上运行服务的多个实例来实现负载均衡，每个节点可以托管服务的多个实例。



#### 定义4 （用户与服务器连接方案）

用户与服务器连接方案 **X** 描述了系统中**用户与服务器的连接关系**：
$$
X = \{ x_{ij} | \forall u_i \in U,s_j \in S,  x_{ij} \in \{0,1\} \}
$$
其中， $x_{ij}$ 表示用户 $u_i$ 是否发送请求到服务器 $s_j$ ：
$$
x_{ij} = 
\begin{cases} 
  1, & \text{用户} u_i \text{发送请求到服务器} s_j \\
  0, & 否则
\end{cases}
$$

### B. 问题公式化

#### 1）响应时间

设 $t_{ij}$ 为连接到服务器 $s_j$ 的用户 $u_i$ 获取服务的响应时间，包括三部分，数据**传输延迟 $t_{send_{ij}}$、处理延迟 $t_{p_{ij}}$ 及传播延迟 $t_{d_{ij}}$**：
$$
t_{ij} = t_{send_{ij}} + t_{p_{ij}} + t_{d_{i,j}}
$$

由于边缘服务器与云服务器的差异，其响应时间的计算方式也有所不同，如下。



##### a. 边缘服务器响应时间 $t_{ij}^e = t_{send_{ij}}^e + t_{p_{ij}}^e + t_{d_{i,j}}^e$

- **传输延迟 $t_{send_{ij}}^e = \frac {D_i^{in} + D_i^{out}}{b_{ij}^e}$** 
  - 表示传输**数据量**与用户服务器之间的**带宽**比


* **处理延迟** $t_{p_{ij}}^e = \frac{p_{i}}{P_{ij}}$


    * 为处理请求需要的**总计算单位**与**服务实例分配给用户**的**计算能力**之比



    * 式中的 $P_{ij}$ 为边缘服务器 $s_j$ 上的服务实例分配给用户 $u_i$ 的计算能力，计算公式为：
      $$
      P_{ij} = (\frac{p_i \cdot W_i}{\sum_{u_k \in U}{(p_k \cdot W_i)}}) \cdot \sum (P^m \cdot y_j)  , \quad  x_{kj} = 1
      $$

      * 公式前半部分的**分子**表示处理用户 $u_i$ 请求需要的**计算单位数**与该用户**权重**的乘积；**分母**表示**连接到服务器** $s_j$ 的**所有用户**需要的计算单位与他们权重乘积之和；整个分式表达了用户 $u_i$ 在服务器 $s_j$ 上的**加权计算单位需求**占连接到该服务器的**所有用户的加权计算单位需求**的**比例**；
      * 公式的后半部分表示了服务器 $s_j$ 上部署的**所有服务实例**的**计算能力的总和**；
      * 通过该分配方式，用户能够根据其需求获得**相应的计算能力**，同时，通过**加权机制**，**高优先级用户**可获得**更多**计算资源，从而体现出模型对不同优先级用户计算能力分配的差异化策略。



* **传播延迟** $t_{d_{ij}}^e$
* 即前面定义的用户与**边缘服务器**之间的基础**传播延迟**



##### b. 云服务器响应时间 $t_{ij}^c = t_{send_{ij}}^c + t_{p_{ij}}^c + t_{d_{i}}^c$

- **传输延迟 $t_{send_{ij}}^c = \frac {D_i^{in} + D_i^{out}}{b_{i}^c}$** 
  - 表示传输**数据量**与用户服务器之间的**带宽**比


* **处理延迟** $t_{p_{ij}}^c = \frac{p_{i}}{P_{cloud}}$

    * 为处理请求需要的**总计算单位**与**云服务器**的**计算能力**之比


* **传播延迟** $t_{d_{i}}^c$

  * 即前面定义的用户与**云服务器**之间的基础**传播延迟**

    


#### 2）加权 Jain 公平性指数

设 $F_{\text{Jain}}$ 为系统中所有用户的响应时间的加权 Jain 指数：
$$
F_{\text{Jain}} = \frac{\left( \sum_{i=1}^{n} t_{ij}^{weight} \right)^2}{n \cdot \sum_{i=1}^{n} \left(t_{ij}^{weight}\right)^2}
$$

其中，$t_{ij}^{weight} = t_{ij} \cdot W_i$ ，为用户 $u_i$ 的加权响应时间；n 为用户总数。

* **公式解释**：    

  * **分子**：所有用户加权响应时间的**总和平方**，反映响应时间的**集中程度**，值越大说明加权时间分布越均衡。

  * **分母**：所有用户加权响应时间的**平方和**，表示响应时间的离散程度，值越大说明时间差异较大。

  * 公式整体衡量了加权响应时间的均衡性，指数越接近 1，表明系统越公平。

  

* **加权作用**：      

  * **影响分子**：**高权重**用户的**短响应时间**有助于**拉近用户间的加权响应时间**，提高公平性。

  * **影响分母**：**高权重**用户的**短响应时间**降低**分母增长速度**，使指数**更接近 1**。

  

* **作用分析**：

  * **提升同优先级用户的公平性**：加权 Jain 指数的最大化保证了**相同优先级**用户的加权响应时间接近，从而减少同级用户间的响应时间差异，提高系统内部的公平性。

  * **保障高优先级用户的低响应时间**：在资源受限的情况下，权重机制确保高优先级用户获得更多计算资源，使其响应时间更短。

  * **整体公平性优化**：Jain 指数越大，说明系统既保证了**相同优先级**用户的响应时间相近，又确保了**跨优先级**用户的响应时间符合优先级设定，即优先级越高的用户响应时间越短，确保了整个系统响应时间的公平性。



#### 3）约束条件

##### 1. 不同优先级用户的平均响应时间约束

各优先级用户的平均响应时间不能超过其最大响应时间限制：
$$
\frac{1}{|U_{L_i}|} \sum_{u_j \in U_{L_i}} \sum_{s_k \in S} x_{jk} \cdot t_{jk} \leq T_{L_i}^{max}, \quad \forall L_i
$$

其中，$T_{L_i}^{max}$ 为优先级 $L_i$ 的用户的最大平均响应时间。



##### 2. 成本约束

系统中的成本不得超过成本预算 $C_{max}$：
$$
C_{edge}  + C_{cloud}  \leq C_{max}
$$
其中：

* $C_{edge}$ 为**边缘服务器**的总成本，计算公式为：
  $$
  C_{edge} = \sum_{s_j \in S_{edge}} c_{fixed_j}^e
  $$

* $C_{cloud}$ 为**云服务器**的总成本，计算公式为：
  $$
  C_{cloud} = \sum_{u_i \in U, s_j \in S_{cloud}} p_{net} \cdot p_i \cdot x_{ij}
  $$
  



##### 3. 边缘服务器计算资源约束

每个边缘服务器上的服务实例所需总资源不超过服务器提供的资源：

$$
y_j \cdot r^m \leq R_j^{server}, \quad \forall s_j \in S_{edge}
$$



##### 4.  用户与服务器的连接约束

为确保所有用户的请求都被处理，每个用户 $u_i$ 必须连接到唯一一个服务器：
$$
\sum_{\forall s_j \in S} x_{ij} = 1, \quad  \forall u_i \in U
$$



#### 4）问题定义

在由 **私有边缘集群 $S_{edge}$ 和公共云 $S_{cloud}$** 组成的微服务系统中，目标是在 **满足各项约束条件** 的前提下 **优化微服务部署方案 Y **，以最大化系统的**公平性**。本研究采用 **用户响应时间** 作为衡量用户服务体验的关键指标，即通过最大化系统所有用户响应时间的**加权 Jain 指数**，优化不同用户在系统中的服务获得情况，从而提升整体公平性。

$$
max \quad F_{jain}
$$

$$
s.t. \quad \frac{1}{|U_{L_i}|} \sum_{u_j \in U_{L_i}} \sum_{s_k \in S} x_{jk} \cdot t_{jk} \leq T_{L_i}^{max}, \quad \forall L_i
$$

$$
C_{edge}  + C_{cloud}  \leq C_{max}
$$

$$
y_j \cdot r^m \leq R_j^{server}, \quad \forall s_j \in S_{edge}
$$

$$
\sum_{\forall s_j \in S} x_{ij} = 1, \quad  \forall u_i \in U
$$



